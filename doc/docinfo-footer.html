<style>
  /* Heading copy-link button */
  .copy-link {
    margin-left: .5rem;
    cursor: pointer;
    border: none;
    background: none;
    font: inherit;
  }
  .copy-link[aria-live] { position: relative; }
  .copy-link::after {
    content: attr(data-toast);
    position: absolute;
    top: -1.75rem;
    left: 50%;
    transform: translateX(-50%);
    padding: .15rem .4rem;
    border-radius: .25rem;
    font-size: .75rem;
    background: #333;
    color: #fff;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s ease;
  }
  .copy-link.show::after { opacity: 1; }

  /* Code block copy button */
  .copy-code {
    position: absolute;
    top: .4rem;
    right: .4rem;
    cursor: pointer;
    border: none;
    background: none;
    padding: .2rem;
    border-radius: .25rem;
  }
  .copy-code svg { width: 16px; height: 16px; }
  .copy-code[aria-live] { position: relative; }
  .copy-code::after {
    content: attr(data-toast);
    position: absolute;
    top: -1.5rem;
    right: 0;
    font-size: .75rem;
    padding: .1rem .3rem;
    border-radius: .25rem;
    background: #333;
    color: #fff;
    opacity: 0;
    pointer-events: none;
    transition: opacity .18s ease;
  }
  .copy-code.show::after { opacity: 1; }

  /* Ensure the button positions inside code blocks */
  .listingblock { position: relative; }

  /* Move code block language label to bottom-right */
  .listingblock pre.highlight {
    position: relative;
    padding-bottom: 0.1rem; /* space for label */
  }
  .listingblock code[data-lang] {
    position: relative;
    display: block;
  }
  .listingblock code[data-lang]::before {
    top: auto;
    bottom: .1rem;
    right: .1rem;
    left: auto;
  }
</style>

<script>
(function () {
  function buildPermalink(id) {
    var loc = window.location;
    return loc.origin + loc.pathname + loc.search + '#' + id;
  }

  function addHeadingCopy() {
    var headings = document.querySelectorAll('h1[id], h2[id], h3[id], h4[id], h5[id], h6[id]');
    headings.forEach(function(h) {
      if (h.querySelector('.copy-link')) return; // avoid duplicates
      var btn = document.createElement('button');
      btn.className = 'copy-link';
      btn.type = 'button';
      btn.title = 'Copy link to this section';
      btn.setAttribute('aria-label', 'Copy link to this section');
      btn.setAttribute('data-toast', 'Copied!');
      btn.innerHTML = '<svg width="16" height="16" viewBox="0 0 24 24" aria-hidden="true"><path d="M3.9 12a5 5 0 0 1 5-5h3v2h-3a3 3 0 0 0 0 6h3v2h-3a5 5 0 0 1-5-5zm6.2 1h3.9a3 3 0 0 0 0-6h-3.9V5h3.9a5 5 0 0 1 0 10h-3.9v-2z"/></svg>';
      btn.addEventListener('click', function () {
        var url = buildPermalink(h.id);
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(url).then(showToast).catch(function () { fallback(url); });
        } else {
          fallback(url);
        }
        function fallback(text) {
          var ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed'; ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); } catch (e) {}
          document.body.removeChild(ta);
          showToast();
        }
        function showToast(){ btn.classList.add('show'); setTimeout(function(){ btn.classList.remove('show'); }, 900); }
      });
      // place after the anchor (if any) so both appear
      h.appendChild(btn);
    });
  }

  function addCodeCopy() {
    document.querySelectorAll('.listingblock pre').forEach(function(pre) {
      var wrapper = pre.closest('.listingblock');
      if (!wrapper || wrapper.querySelector('.copy-code')) return; // avoid duplicates
      var btn = document.createElement('button');
      btn.className = 'copy-code';
      btn.type = 'button';
      btn.title = 'Copy code';
      btn.setAttribute('aria-label', 'Copy code block');
      btn.setAttribute('data-toast', 'Copied!');
      btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg>';
      btn.addEventListener('click', function () {
        var code = pre.innerText; // get visible text from the code block
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(code).then(showToast).catch(function () { fallback(code); });
        } else {
          fallback(code);
        }
        function fallback(text) {
          var ta = document.createElement('textarea');
          ta.value = text;
          ta.style.position = 'fixed'; ta.style.left = '-9999px';
          document.body.appendChild(ta);
          ta.select();
          try { document.execCommand('copy'); } catch (e) {}
          document.body.removeChild(ta);
          showToast();
        }
        function showToast(){ btn.classList.add('show'); setTimeout(function(){ btn.classList.remove('show'); }, 900); }
      });
      wrapper.appendChild(btn);
    });
  }

  function init(){
    addHeadingCopy();
    addCodeCopy();
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>